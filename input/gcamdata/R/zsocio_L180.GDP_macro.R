# Copyright 2019 Battelle Memorial Institute; see the LICENSE file.

#' module_socio_L180.GDP_macro
#'
#' National accounts information for GDP macro.
#'
#' @param command API command to execute
#' @param ... other optional parameters, depending on command
#' @return Depends on \code{command}: either a vector of required inputs,
#' a vector of output names, or (if \code{command} is "MAKE") all
#' the generated outputs: \code{L180.nationalAccounts}, \code{L180.laborForceSSP}.
#' There is no corresponding file in the original data system.
#' @details Select national accounts data from Penn World Table for all countries.
#' @importFrom assertthat assert_that
#' @importFrom dplyr filter lag mutate mutate_at select rename
#' @author SHK October 2020
#'
module_socio_L180.GDP_macro <- function(command, ...) {

  MODULE_INPUTS <-
    c(FILE = "common/iso_GCAM_regID",
      FILE = "common/GCAM_region_names",
      FILE = "socioeconomics/SSP/SSP_database_2024",
      FILE = "socioeconomics/SSP/pop_laborforce_variable",
      FILE = "socioeconomics/SSP/iso_SSP_regID",
      FILE = "socioeconomics/PWT/pwt91",
      FILE = "socioeconomics/PWT/pwt91_na",
      # PWT v9 will be updated to PWT v10 soon
      #FILE = "socioeconomics/PWT/pwt1001",
      #FILE = "socioeconomics/PWT/pwt1001_na",
      "L100.GTAP_capital_stock")

  MODULE_OUTPUTS <-
    c("L180.nationalAccounts",
      "L180.laborForceSSP")

  if(command == driver.DECLARE_INPUTS) {
    return(MODULE_INPUTS)
  } else if(command == driver.DECLARE_OUTPUTS) {
    return(MODULE_OUTPUTS)
  } else if(command == driver.MAKE) {

    # silence package checks
    scenario <- year <- gdp <- GCAM_region_ID <- account <- Region <- Units <- growth <- timestep <- region <-
      GDP <- pop <- laborproductivity <- NULL

    # --------------------------------------------------	---------------------------
    # 1. Read data

    all_data <- list(...)[[1]]

    # Load required inputs ----
    get_data_list(all_data, MODULE_INPUTS, strip_attributes = TRUE)

    # Define data source/version ----
    # note this data is based on market exchange rate (mer)
    # macroeconomic date from Penn World Tables
    PWT.raw <- pwt91
    PWT.supplemental <- pwt91_na
    gcam.reg.iso <- iso_GCAM_regID


    # -----------------------------------------------------------------------------
    # Data ID Info for Penn World Table used here (for complete list, see PWT91 in raw data)
    # Variable name       Variable definition
    # countrycode	        3-letter ISO country code
    # country	            Country name
    # currency_unit	      Currency unit
    # year	              Year
    # rgdpo               Output-side real GDP at chained PPPs (in mil. 2011US$)
    # pop	                Population (in millions)
    # emp	                Number of persons engaged (in millions)
    # avh	                Average annual hours worked by persons engaged
    # hc	                Index of human capital per person, based on years of schooling (see PWT9)
    # rgdpna	            RealGDP at constant 2011 national prices (in mil. 2011US$)
    # rconna	            Real consumption at constant 2011 national prices (in mil. 2011US$)
    # rdana	              Real domestic absorption at constant 2011 national prices (in mil. 2011US$)
    ## Real domestic absorption = consumption (HH+G) + investment
    # rnna	              Capital stock at constant 2011 national prices (in mil. 2011US$)
    # rtfpna	            TFP at constant national prices (2011=1)
    # labsh	              Share of labour compensation in GDP at current national prices
    # delta           	  Average depreciation rate of the capital stock
    #

    PWT.raw %>% select(countrycode, country, year, pop, emp, avh, rgdpna, rconna, rdana,
                       rnna, labsh, delta, irr) %>%
      rename(iso = countrycode,
             labor.force = emp,
             hrs.worked.annual = avh,
             pop.pwt = pop,
             gdp.pwt = rgdpna,
             consumption = rconna,
             cons.plus.invest = rdana,
             capital.stock = rnna,
             labor.share.gdp = labsh,
             depreciation.rate = delta,
             interest.rate = irr) %>%
      mutate(iso = tolower(iso)) %>%
      gather(var, value, -iso, -country, -year) %>%
      filter(!is.na(value)) -> pwt

    # process supplemental data to be consistent with main pwt data, namely:
    # 1. convert from constant local currency to constant USD using the provided
    #    exchange rate in the base dollar year
    # 2. ensure export and imports balance globally (they are off by ~ 1-2%)
    PWT.supplemental %>%
      rename(iso = countrycode) %>%
      mutate(iso = tolower(iso)) %>%
      filter(iso %in% unique(pwt$iso)) ->
      PWT.supplemental

    PWT.supplemental %>%
      # get the exchange rate of the base dollar year
      filter(year == socioeconomics.PWT_CONSTANT_CURRENCY_YEAR) %>%
      select(iso, xr) %>%
      # join that exchange rate back onto the base q_x, q_m (exports and imports)
      # which are already in the base currency year so that we can jump from
      # local currency to USD
      left_join_error_no_match(PWT.supplemental %>% select(iso, year, q_x, q_m), ., by=c("iso")) %>%
      mutate(exports = q_x / xr,
             imports = q_m / xr) %>%
      select(iso, year, exports, imports) %>%
      # scale imports so that they exactly match exports globally
      group_by(year) %>%
      mutate(imports = imports * sum(exports, na.rm=T) / sum(imports, na.rm = T)) %>%
      ungroup() %>%
      gather(var, value, -iso, -year) %>%
      filter(!is.na(value)) -> pwt_supp

    pwt %>%
      select(-country) %>%
      bind_rows(pwt_supp) ->
      pwt

    # replace iso:sxm with iso:nld for Dutch part of Saint Maarten
    # pwt %>% mutate(iso = gsub("sxm", "nld", iso)) %>%
    #   group_by(iso, var, year) %>%
    #   summarise_all(sum, na.rm = TRUE) %>%
    #   ungroup() -> pwt

    ## Process and aggregate data to GCAM inputs
    ## Check for iso errors, do not include.
    pwt %>% filter(!(iso %in% gcam.reg.iso$iso)) -> pwt.no.iso
    assertthat::assert_that(nrow(pwt.no.iso) == 0)

    pwt %>%
      left_join_error_no_match(gcam.reg.iso, by = "iso") %>%
      spread(var, value) %>%
      mutate(hrs.worked.annual = if_else(is.na(hrs.worked.annual), socioeconomics.DEFAULT_MEDIAN_HOURS_WORKED, hrs.worked.annual), # Replace missing with median average hours
             wages = gdp.pwt * labor.share.gdp, #million 2011US$
             wage.rate = wages / labor.force / hrs.worked.annual, #wages/worker-hr
             labor.force.share = labor.force / pop.pwt,
             depreciation = capital.stock * depreciation.rate,
             investment = cons.plus.invest - consumption,
             net.export = exports - imports,
             capital.net.export = -net.export,
             savings = investment - capital.net.export,
             savings.rate = savings / gdp.pwt) -> nationalAccounts.2011dollar

    # Convert all US dollar year from 2011 to 1990 for consistency with GCAM input
    nationalAccounts.2011dollar %>% mutate( gdp.pwt = gdp.pwt * gdp_deflator(1990, 2011),
                                            consumption = consumption * gdp_deflator(1990, 2011),
                                            cons.plus.invest = cons.plus.invest * gdp_deflator(1990, 2011),
                                            wages = wages * gdp_deflator(1990, 2011),
                                            wage.rate = wage.rate * gdp_deflator(1990, 2011),
                                            capital.stock = capital.stock * gdp_deflator(1990, 2011),
                                            depreciation = depreciation * gdp_deflator(1990, 2011),
                                            investment = investment * gdp_deflator(1990, 2011),
                                            savings = savings * gdp_deflator(1990, 2011),
                                            capital.net.export = capital.net.export * gdp_deflator(1990, 2011)) -> L180.nationalAccounts

    # We want to partition the total capital stock and investment to split out energy capital usage
    # The Penn World table does not include this level of detail so we will need to utilize GTAP
    # capital data to do this.  The two datasets will not agree on total capital stock values so
    # instead we will compute shares from the GTAP data then apply that to the Penn World table values

    # Note: we will have fewer countries in the GTAP databases.  We will give the missing countries
    # the GCAM regional shares so first compute that.
    L100.GTAP_capital_stock %>%
      group_by(region_GCAM, year) %>%
      mutate(invest_total = sum(CapitalCost), stock_total = sum(VKE)) %>%
      group_by(region_GCAM, year, GCAM_sector) %>%
      summarize(gtap_ene_inv_share = sum(CapitalCost) / mean(invest_total),
                gtap_ene_stock_share = sum(VKE) / mean(stock_total)) %>%
      ungroup() ->
      GTAP_inv_share.regional
    # Compute shares for the countries we have
    L100.GTAP_capital_stock %>%
      group_by(region_GTAP, year) %>%
      mutate(invest_total = sum(CapitalCost), stock_total = sum(VKE)) %>%
      group_by(region_GTAP, year, GCAM_sector) %>%
      summarize(gtap_ene_inv_share = sum(CapitalCost) / mean(invest_total),
                gtap_ene_stock_share = sum(VKE) / mean(stock_total)) %>%
      ungroup() ->
      GTAP_inv_share.ctry
    # Set the shares for the countries not included in GTAP
    L180.nationalAccounts %>%
      select(iso) %>%
      distinct() %>%
      left_join_error_no_match(gcam.reg.iso %>% select(iso, GCAM_region_ID), by=c("iso")) %>%
      filter(!iso %in% unique(L100.GTAP_capital_stock$region_GTAP)) %>%
      left_join_error_no_match(GCAM_region_names, by=c("GCAM_region_ID")) %>%
      select(region_GTAP = iso, region_GCAM = region) %>%
      # note: we are using left_join as we are using it to filter the ISOs which
      # are not available in GTAP (which of course will the get assigned regional
      # average shares)
      left_join(GTAP_inv_share.regional, by=c("region_GCAM")) %>%
      select(-region_GCAM) %>%
      # combine with the GTAP ctry shares to now have coverage across all ISOs
      bind_rows(GTAP_inv_share.ctry) %>%
      rename(iso = region_GTAP) ->
      GTAP_inv_share

    # filter for just Energy as that is what we are interested at the moment, then fillout for
    # all historical years holding values constant beyond the endpoints of the GTAP data
    GTAP_inv_share %>%
      filter(GCAM_sector == "Energy") %>%
      select(-GCAM_sector) %>%
      full_join(tibble(year = unique(L180.nationalAccounts$year)), by=c("year")) %>%
      complete(year, nesting(iso)) %>%
      group_by(iso) %>%
      mutate(gtap_ene_inv_share = approx_fun(year, gtap_ene_inv_share, rule = 2),
             gtap_ene_stock_share = approx_fun(year, gtap_ene_stock_share, rule = 2)) %>%
      ungroup() ->
      GTAP_inv_share_complete

    # Finally, adjust the Penn World table values with the GTAP capital shares
    L180.nationalAccounts %>%
      left_join_error_no_match(GTAP_inv_share_complete, by=c("iso", "year")) %>%
      mutate(capital.stock = capital.stock * (1.0 - gtap_ene_stock_share),
             depreciation = depreciation * (1.0 - gtap_ene_stock_share),
             energy.investment = investment * gtap_ene_inv_share) %>%
      select(-gtap_ene_inv_share, -gtap_ene_stock_share) ->
      L180.nationalAccounts

    # Some ISOs have missing interest rates, attempt to fill them using
    # rule=2 and if still missing (i.e. the country has no data for any
    # year) just fall back to the global mean
    L180.nationalAccounts %>%
      group_by(iso) %>%
      mutate(interest.rate = approx_fun(year, interest.rate, rule=2)) %>%
      ungroup() %>%
      mutate(interest.rate = if_else(is.na(interest.rate), mean(interest.rate, na.rm=T), interest.rate)) ->
      L180.nationalAccounts

    # Using SSP database to derive future labor force
    SSP_database_2024 %>%
      # make variable names lower case
      dplyr::rename_all(tolower) %>%
      # remove aggregated regions
      filter(!grepl("\\(|World", region)) %>%
      filter(model == "IIASA-WiC POP 2023") %>%
      left_join_error_no_match(
        iso_SSP_regID %>% distinct(iso, region = ssp_country_name),
        by = "region") %>%
      gather_years() ->
      SSP_pop_0

    # Using the Historical Reference scenario to fill history of SSPs
    SSP_pop_0 %>%
      filter(scenario != "Historical Reference") %>%
      left_join(
        SSP_pop_0 %>% filter(scenario == "Historical Reference") %>% select(-scenario) %>%
          rename(hist = value),
        by = c("model", "region", "variable", "unit", "iso", "year")
      ) %>%
      # new ssp data starts 2020 (socioeconomics.SSP_DB_BASEYEAR)
      mutate(value = if_else(year < socioeconomics.SSP_DB_BASEYEAR, hist, value)) %>%
      select(-hist) ->
      SSP_pop_1

    SSP_pop_1 %>% filter(variable == "Population") %>%
      transmute(scenario, iso, var = "pop", unit, year, value) ->
      pop.ssp

    SSP_pop_1 %>%
      left_join_error_no_match(
        pop_laborforce_variable %>% filter(version == "sspv3"), by = "variable") %>%
      filter(laborforce_var == TRUE) %>%
      # Note that in historical years, population was not differentiated by education
      # We also do not have that differentiation now (NA could cause issues)
      # Since the population to labor force will have another rescaling when connecting to
      # PWT labor force base values
      group_by(scenario, iso, unit, year) %>%
      summarize(value = sum(value, na.rm = T)) %>% ungroup %>%
      mutate(var = "labor.force") ->
      labor.force.ssp


    #include total SSP population (pop) in table
    labor.force.ssp %>%
      bind_rows(pop.ssp) %>%
      mutate(scenario = tolower(scenario)) %>%
      left_join_error_no_match(gcam.reg.iso, by = "iso") %>%
      select(scenario, iso, GCAM_region_ID, var, year, value, unit) %>%
      arrange(scenario, iso, var, year) ->
      L180.laborForceSSP

    # WARNING!!!
    # Not all data is available for every country and year.
    # Check for missing national accounts data by country before using for GCAM region.
    # All rates and shares should be recalculated based on total values for GCAM aggregte regions.
    L180.nationalAccounts %>% select(iso, country_name, GCAM_region_ID, year,
                                     pop.pwt, labor.force, gdp.pwt, consumption,
                                     cons.plus.invest, capital.stock, depreciation,
                                     savings, wages, hrs.worked.annual, wage.rate,
                                     labor.force.share, depreciation.rate, savings.rate,
                                     interest.rate, energy.investment, capital.net.export ) -> L180.nationalAccounts

    # ===================================================

    # Produce outputs

    L180.laborForceSSP %>%
      add_title("Labor Force and Pop by SSP Scenarios") %>%
      add_units("millions") %>%
      add_comments("Total pop and working age population") %>%
      add_legacy_name("NA") %>%
      add_precursors("common/iso_GCAM_regID",
                     "socioeconomics/SSP/SSP_database_2024",
                     "socioeconomics/SSP/pop_laborforce_variable",
                     "socioeconomics/SSP/iso_SSP_regID") ->
      L180.laborForceSSP

    L180.nationalAccounts %>%
      add_title("Processed National Accounts Data from Penn World Table") %>%
      add_units("million 1990US$") %>%
      add_comments("National accounts data: GDP, capital, depreciation, savings rate,
               labor wages, labor productivity, labor force, and labor force share, energy investment") %>%
      add_legacy_name("NA") %>%
      add_precursors("common/iso_GCAM_regID", "common/GCAM_region_names",
                     "socioeconomics/PWT/pwt91", "socioeconomics/PWT/pwt91_na",
                     "L100.GTAP_capital_stock") ->
      L180.nationalAccounts

    return_data(MODULE_OUTPUTS)

  } else {
    stop("Unknown command")
  }
}
